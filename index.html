<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultorios dra. Abraldes - Gestión de Turnos</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        medical: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            900: '#134e4a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Import Map for React, ReactDOM, Lucide and Firebase structure -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f0fdfa; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Calendar, Clock, MapPin, User, Stethoscope, ChevronRight, CheckCircle2, AlertCircle, Home, LogOut, Loader2, Wifi, WifiOff, Settings, Plus, Trash2, Save } from 'lucide-react';
        
        // --- CONFIGURACIÓN DE FIREBASE SIMPLIFICADA ---
        // INSTRUCCIONES: Reemplaza los valores abajo con los de tu consola de Firebase
        const manualConfig = {
            apiKey: "TU_API_KEY_AQUI", 
            authDomain: "tu-proyecto.firebaseapp.com",
            projectId: "tu-proyecto",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        // --- MODELO DE DATOS INICIAL (DEFAULT) ---
        const DEFAULT_CONSULTORIOS = [
            {
                id: 1,
                name: "Consultorio Central",
                address: "Av. Corrientes 1234, PB",
                days: [1, 2, 3, 4, 5], // Lun-Vie
                startHour: 9,
                endHour: 17,
                duration: 30, // minutos
                insurances: ["OSDE", "Swiss Medical", "Galeno", "Particular"]
            },
            {
                id: 2,
                name: "Clínica Norte",
                address: "Calle 14 Nro 500, San Martín",
                days: [1, 3, 5], // Lun, Mie, Vie
                startHour: 14,
                endHour: 20,
                duration: 20,
                insurances: ["IOMA", "PAMI", "Particular"]
            },
            {
                id: 3,
                name: "Consultorio Pediatría",
                address: "Mitre 880, 1ro A",
                days: [2, 4], // Mar, Jue
                startHour: 10,
                endHour: 16,
                duration: 45,
                insurances: ["Todas las Obras Sociales"]
            }
        ];

        // --- UTILIDADES ---
        const formatDateDisplay = (dateStr) => {
            if (!dateStr) return '-';
            // Asume dateStr en formato YYYY-MM-DD
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        };

        // --- COMPONENTES UI REUTILIZABLES ---

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'success' ? 'bg-emerald-600' : 'bg-red-500';

            return (
                <div className={`fixed top-4 right-4 z-50 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 fade-in ${bgClass}`}>
                    {type === 'success' ? <CheckCircle2 size={20} /> : <AlertCircle size={20} />}
                    <span className="font-medium">{message}</span>
                </div>
            );
        };

        const Card = ({ children, className = "", ...props }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-medical-100 p-6 ${className}`} {...props}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', disabled = false, fullWidth = false, icon: Icon, type = "button" }) => {
            const baseClass = "px-4 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-medical-600 hover:bg-medical-700 text-white shadow-md shadow-medical-200",
                secondary: "bg-white border-2 border-medical-100 text-medical-700 hover:border-medical-500 hover:bg-medical-50",
                ghost: "text-gray-500 hover:bg-gray-100 hover:text-gray-700"
            };

            return (
                <button 
                    type={type}
                    onClick={onClick} 
                    disabled={disabled}
                    className={`${baseClass} ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                >
                    {disabled ? <Loader2 className="animate-spin" size={20} /> : (Icon && <Icon size={20} />)}
                    {children}
                </button>
            );
        };

        // --- LOGICA PRINCIPAL (HOOKS Y APP) ---

        const App = () => {
            // Estado Global
            const [view, setView] = useState('landing'); // landing, patient, professional, admin
            const [appointments, setAppointments] = useState([]);
            // Estado para Consultorios (Ahora dinámico)
            const [consultorios, setConsultorios] = useState(DEFAULT_CONSULTORIOS);
            const [pendingSyncs, setPendingSyncs] = useState([]);
            const [toast, setToast] = useState(null);
            const [isOnline, setIsOnline] = useState(true); // Simulación de estado de red
            const [firebaseReady, setFirebaseReady] = useState(false);

            // Inicialización
            useEffect(() => {
                // 1. Cargar LocalStorage
                const localData = localStorage.getItem('appointments');
                const localQueue = localStorage.getItem('pendingSyncs');
                const localConsultorios = localStorage.getItem('consultorios'); // Cargar consultorios
                
                if (localData) setAppointments(JSON.parse(localData));
                if (localQueue) setPendingSyncs(JSON.parse(localQueue));
                // Si existen consultorios guardados, usarlos; si no, usar default
                if (localConsultorios) setConsultorios(JSON.parse(localConsultorios));

                // 2. Verificar Config Firebase
                if (manualConfig.apiKey !== "TU_API_KEY_AQUI") {
                    console.log("Firebase configurado (Simulado)");
                    setFirebaseReady(true);
                } else {
                    console.log("Modo Local: Firebase no configurado");
                }

                // Listener de conexión
                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));

                return () => {
                    window.removeEventListener('online', () => setIsOnline(true));
                    window.removeEventListener('offline', () => setIsOnline(false));
                };
            }, []);

            // Mostrar Toast
            const showToast = (msg, type = 'success') => setToast({ message: msg, type, id: Date.now() });

            // Guardar Consultorios
            const saveConsultorios = (newConsultorios) => {
                setConsultorios(newConsultorios);
                localStorage.setItem('consultorios', JSON.stringify(newConsultorios));
                showToast("Configuración de consultorios guardada");
            };

            // Persistencia Híbrida
            const saveAppointment = (newAppointment) => {
                try {
                    // 1. Guardar en Estado
                    const updatedAppointments = [...appointments, newAppointment];
                    setAppointments(updatedAppointments);

                    // 2. Guardar en LocalStorage (Offline Priority)
                    localStorage.setItem('appointments', JSON.stringify(updatedAppointments));

                    // 3. Cola de Sincronización
                    const syncItem = { action: 'ADD', data: newAppointment, timestamp: Date.now() };
                    const updatedQueue = [...pendingSyncs, syncItem];
                    setPendingSyncs(updatedQueue);
                    localStorage.setItem('pendingSyncs', JSON.stringify(updatedQueue));

                    // 4. Intentar Sync (Si hay Firebase)
                    if (firebaseReady && isOnline) {
                        // syncWithFirebase(updatedQueue); -> Lógica futura
                        console.log("Intentando sincronizar con Firebase...");
                        setTimeout(() => {
                            setPendingSyncs([]);
                            localStorage.setItem('pendingSyncs', JSON.stringify([]));
                        }, 2000);
                    }

                    return true;
                } catch (error) {
                    console.error("Error al guardar:", error);
                    return false;
                }
            };

            // --- VISTAS ---

            if (view === 'landing') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-br from-medical-50 to-white relative">
                        {/* Botón Admin Flotante */}
                        <button 
                            onClick={() => setView('admin')}
                            className="absolute top-6 right-6 p-2 text-gray-400 hover:text-medical-600 transition-colors"
                            title="Configuración de Consultorios"
                        >
                            <Settings size={24} />
                        </button>

                        <div className="text-center mb-10 max-w-lg">
                            <div className="bg-medical-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Stethoscope className="text-medical-600" size={40} />
                            </div>
                            <h1 className="text-4xl font-bold text-gray-900 mb-4">Consultorios dra. Abraldes</h1>
                            <p className="text-gray-600 text-lg">Bienvenido al sistema de gestión de turnos integrado.</p>
                            
                            {!firebaseReady && (
                                <div className="mt-4 inline-flex items-center gap-2 px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">
                                    <WifiOff size={14} /> Modo Local (Offline-First)
                                </div>
                            )}
                        </div>

                        <div className="grid md:grid-cols-2 gap-6 w-full max-w-4xl">
                            <Card className="hover:border-medical-400 cursor-pointer transition-all hover:shadow-md group" >
                                <div className="flex flex-col h-full justify-between" onClick={() => setView('patient')}>
                                    <div>
                                        <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 mb-4 group-hover:scale-110 transition-transform">
                                            <User size={24} />
                                        </div>
                                        <h2 className="text-xl font-bold text-gray-900 mb-2">Soy Paciente</h2>
                                        <p className="text-gray-500">Solicitar un nuevo turno médico, ver consultorios y horarios disponibles.</p>
                                    </div>
                                    <Button className="mt-6 w-full" onClick={() => setView('patient')}>
                                        Solicitar Turno <ChevronRight size={18} />
                                    </Button>
                                </div>
                            </Card>

                            <Card className="hover:border-medical-400 cursor-pointer transition-all hover:shadow-md group">
                                <div className="flex flex-col h-full justify-between" onClick={() => setView('professional')}>
                                    <div>
                                        <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600 mb-4 group-hover:scale-110 transition-transform">
                                            <Calendar size={24} />
                                        </div>
                                        <h2 className="text-xl font-bold text-gray-900 mb-2">Soy Profesional</h2>
                                        <p className="text-gray-500">Acceder a la agenda diaria, semanal y mensual. Gestionar pacientes.</p>
                                    </div>
                                    <Button variant="secondary" className="mt-6 w-full" onClick={() => setView('professional')}>
                                        Ver Agenda <ChevronRight size={18} />
                                    </Button>
                                </div>
                            </Card>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-medical-50">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    <header className="bg-white shadow-sm sticky top-0 z-40">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('landing')}>
                                <div className="bg-medical-600 text-white p-1.5 rounded-md">
                                    <Stethoscope size={20} />
                                </div>
                                <span className="font-bold text-gray-800 hidden sm:block">Consultorios dra. Abraldes</span>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-1.5 text-xs font-medium text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full">
                                    {pendingSyncs.length > 0 ? (
                                        <><Loader2 className="animate-spin text-orange-500" size={14} /> Sincronizando ({pendingSyncs.length})</>
                                    ) : (
                                        <><CheckCircle2 className="text-emerald-500" size={14} /> Guardado</>
                                    )}
                                </div>
                                <Button variant="ghost" onClick={() => setView('landing')}>
                                    <LogOut size={18} /> <span className="hidden sm:inline">Salir</span>
                                </Button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-8">
                        {view === 'patient' && (
                            <PatientView 
                                consultorios={consultorios} 
                                appointments={appointments}
                                onSave={(apt) => {
                                    if(saveAppointment(apt)) {
                                        showToast("Turno confirmado exitosamente");
                                        setView('landing');
                                    } else {
                                        showToast("Error al guardar", "error");
                                    }
                                }}
                                onCancel={() => setView('landing')}
                            />
                        )}
                        {view === 'professional' && (
                            <ProfessionalView 
                                consultorios={consultorios} 
                                appointments={appointments}
                            />
                        )}
                        {view === 'admin' && (
                            <AdminView 
                                consultorios={consultorios} 
                                onSave={saveConsultorios}
                            />
                        )}
                    </main>
                </div>
            );
        };

        // --- VISTA ADMIN ---
        const AdminView = ({ consultorios, onSave }) => {
            const [editingList, setEditingList] = useState(JSON.parse(JSON.stringify(consultorios)));
            const [expandedId, setExpandedId] = useState(null);

            const handleChange = (id, field, value) => {
                setEditingList(prev => prev.map(c => c.id === id ? { ...c, [field]: value } : c));
            };

            const toggleDay = (consultoryId, dayIndex) => {
                setEditingList(prev => prev.map(c => {
                    if (c.id !== consultoryId) return c;
                    const newDays = c.days.includes(dayIndex) 
                        ? c.days.filter(d => d !== dayIndex)
                        : [...c.days, dayIndex].sort();
                    return { ...c, days: newDays };
                }));
            };

            const addNew = () => {
                const newId = Math.max(...editingList.map(c => c.id), 0) + 1;
                const newConsultory = {
                    id: newId,
                    name: "Nuevo Consultorio",
                    address: "",
                    days: [1, 2, 3, 4, 5],
                    startHour: 9,
                    endHour: 17,
                    duration: 30,
                    insurances: []
                };
                setEditingList([...editingList, newConsultory]);
                setExpandedId(newId);
            };

            const remove = (id) => {
                if (confirm("¿Estás seguro de eliminar este consultorio?")) {
                    setEditingList(editingList.filter(c => c.id !== id));
                }
            };

            const DAYS = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];

            return (
                <div className="max-w-4xl mx-auto fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <Settings className="text-medical-600"/> Configuración de Consultorios
                        </h2>
                        <Button onClick={() => onSave(editingList)} icon={Save}>Guardar Cambios</Button>
                    </div>

                    <div className="space-y-4">
                        {editingList.map(cons => (
                            <Card key={cons.id} className={`transition-all ${expandedId === cons.id ? 'ring-2 ring-medical-500' : ''}`}>
                                <div className="flex justify-between items-start mb-4">
                                    <div className="flex-1 cursor-pointer" onClick={() => setExpandedId(expandedId === cons.id ? null : cons.id)}>
                                        <h3 className="font-bold text-lg text-gray-800">{cons.name}</h3>
                                        <p className="text-sm text-gray-500">{cons.address || "Sin dirección"}</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setExpandedId(expandedId === cons.id ? null : cons.id)} className="p-2 text-medical-600 hover:bg-medical-50 rounded">
                                            {expandedId === cons.id ? 'Cerrar' : 'Editar'}
                                        </button>
                                        <button onClick={() => remove(cons.id)} className="p-2 text-red-500 hover:bg-red-50 rounded">
                                            <Trash2 size={18} />
                                        </button>
                                    </div>
                                </div>

                                {expandedId === cons.id && (
                                    <div className="grid md:grid-cols-2 gap-4 pt-4 border-t border-gray-100 animate-fadeIn">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                                            <input type="text" className="w-full border border-gray-300 rounded p-2 text-sm"
                                                value={cons.name} onChange={e => handleChange(cons.id, 'name', e.target.value)} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                                            <input type="text" className="w-full border border-gray-300 rounded p-2 text-sm"
                                                value={cons.address} onChange={e => handleChange(cons.id, 'address', e.target.value)} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Obras Sociales (Separa por comas)</label>
                                            <input type="text" className="w-full border border-gray-300 rounded p-2 text-sm"
                                                value={cons.insurances.join(', ')} 
                                                onChange={e => handleChange(cons.id, 'insurances', e.target.value.split(',').map(s => s.trim()))} />
                                        </div>
                                        <div className="grid grid-cols-3 gap-2">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Inicio (Hora)</label>
                                                <input type="number" min="0" max="23" className="w-full border border-gray-300 rounded p-2 text-sm"
                                                    value={cons.startHour} onChange={e => handleChange(cons.id, 'startHour', parseInt(e.target.value))} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Fin (Hora)</label>
                                                <input type="number" min="0" max="23" className="w-full border border-gray-300 rounded p-2 text-sm"
                                                    value={cons.endHour} onChange={e => handleChange(cons.id, 'endHour', parseInt(e.target.value))} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Duración (min)</label>
                                                <input type="number" step="5" className="w-full border border-gray-300 rounded p-2 text-sm"
                                                    value={cons.duration} onChange={e => handleChange(cons.id, 'duration', parseInt(e.target.value))} />
                                            </div>
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Días de Atención</label>
                                            <div className="flex flex-wrap gap-2">
                                                {DAYS.map((day, idx) => (
                                                    <button 
                                                        key={idx}
                                                        onClick={() => toggleDay(cons.id, idx)}
                                                        className={`px-3 py-1 rounded-full text-xs font-medium border transition-colors ${
                                                            cons.days.includes(idx) 
                                                            ? 'bg-medical-600 text-white border-medical-600' 
                                                            : 'bg-white text-gray-500 border-gray-300 hover:border-medical-300'
                                                        }`}
                                                    >
                                                        {day}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </Card>
                        ))}

                        <button onClick={addNew} className="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-medical-500 hover:text-medical-600 hover:bg-gray-50 transition-all flex items-center justify-center gap-2 font-medium">
                            <Plus size={20} /> Agregar Nuevo Consultorio
                        </button>
                    </div>
                </div>
            );
        };

        // --- VISTA PACIENTE ---

        const PatientView = ({ consultorios, appointments, onSave, onCancel }) => {
            const [step, setStep] = useState(1);
            const [selectedRoom, setSelectedRoom] = useState(null);
            const [formData, setFormData] = useState({
                name: '', age: '', phone: '', insurance: ''
            });
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [selectedSlot, setSelectedSlot] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);

            // Generar Slots Disponibles (Algoritmo de Agrupamiento)
            const availableSlots = useMemo(() => {
                if (!selectedRoom || !selectedDate) return [];

                const room = consultorios.find(r => r.id === selectedRoom);
                
                const [y, m, d] = selectedDate.split('-').map(Number);
                const dateObj = new Date(y, m - 1, d, 12, 0, 0); 
                const dayOfWeek = dateObj.getDay(); 

                if (!room.days.includes(dayOfWeek)) return []; 

                const slots = [];
                const existingApts = appointments.filter(a => 
                    a.consultoryId === selectedRoom && a.date === selectedDate
                );

                let currentTime = room.startHour * 60; // Convertir a minutos
                const endTime = room.endHour * 60;

                while (currentTime + room.duration <= endTime) {
                    const startMin = currentTime;
                    const endMin = currentTime + room.duration;
                    
                    // Formato HH:MM
                    const formatTime = (min) => {
                        const h = Math.floor(min / 60).toString().padStart(2, '0');
                        const m = (min % 60).toString().padStart(2, '0');
                        return `${h}:${m}`;
                    };

                    const slotLabel = `${formatTime(startMin)} - ${formatTime(endMin)}`;
                    
                    // Verificar colisión
                    const isOccupied = existingApts.some(apt => apt.slot === slotLabel);

                    if (!isOccupied) {
                        const isAdjacent = existingApts.some(apt => {
                            const [aptStart, aptEnd] = apt.slot.split(' - ');
                            return aptEnd === formatTime(startMin) || aptStart === formatTime(endMin);
                        });

                        slots.push({
                            label: slotLabel,
                            start: startMin,
                            priority: isAdjacent ? 1 : 0 
                        });
                    }

                    currentTime += room.duration;
                }

                return slots.sort((a, b) => {
                    if (b.priority !== a.priority) return b.priority - a.priority;
                    return a.start - b.start;
                });

            }, [selectedRoom, selectedDate, consultorios, appointments]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!selectedSlot || !selectedRoom || isSubmitting) return;

                setIsSubmitting(true);
                
                // Simular delay de red para UX
                setTimeout(() => {
                    const newApt = {
                        id: crypto.randomUUID(),
                        consultoryId: selectedRoom,
                        consultoryName: consultorios.find(c => c.id === selectedRoom).name,
                        ...formData,
                        date: selectedDate,
                        slot: selectedSlot.label,
                        timestamp: Date.now(),
                        status: 'confirmed'
                    };
                    onSave(newApt);
                    setIsSubmitting(false);
                }, 800);
            };

            if (step === 1) {
                return (
                    <div className="fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">Seleccione un Consultorio</h2>
                        <div className="grid md:grid-cols-3 gap-6">
                            {consultorios.map(room => (
                                <Card key={room.id} className="cursor-pointer hover:border-medical-500 hover:shadow-md transition-all h-full flex flex-col justify-between" onClick={() => { setSelectedRoom(room.id); setStep(2); }}>
                                    <div>
                                        <div className="flex items-center gap-3 mb-3">
                                            <div className="bg-medical-100 p-2 rounded-lg text-medical-700">
                                                <MapPin size={24} />
                                            </div>
                                            <h3 className="font-bold text-lg text-gray-800">{room.name}</h3>
                                        </div>
                                        <p className="text-gray-500 text-sm mb-2">{room.address}</p>
                                        <div className="flex flex-wrap gap-1 mb-4">
                                            {room.insurances.slice(0, 2).map(ins => (
                                                <span key={ins} className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">{ins}</span>
                                            ))}
                                            {room.insurances.length > 2 && <span className="text-xs text-gray-400 self-center">+{room.insurances.length - 2} más</span>}
                                        </div>
                                    </div>
                                    <div className="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center text-sm text-medical-700 font-medium">
                                        <span>Turnos de {room.duration} min</span>
                                        <ChevronRight size={16} />
                                    </div>
                                </Card>
                            ))}
                        </div>
                    </div>
                );
            }

            const activeRoom = consultorios.find(r => r.id === selectedRoom);
            const DAYS_LABEL = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

            return (
                <div className="max-w-4xl mx-auto fade-in">
                    <button onClick={() => setStep(1)} className="text-gray-500 hover:text-medical-600 mb-4 flex items-center gap-1 text-sm">
                        &larr; Volver a consultorios
                    </button>
                    
                    <div className="grid md:grid-cols-3 gap-8">
                        {/* Columna Izquierda: Formulario */}
                        <div className="md:col-span-2">
                            <Card>
                                <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <User size={20} className="text-medical-600"/> Datos del Paciente
                                </h3>
                                <form id="bookingForm" onSubmit={handleSubmit} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Nombre y Apellido</label>
                                            <input required type="text" className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-medical-500 outline-none" 
                                                value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Edad</label>
                                            <input required type="number" className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-medical-500 outline-none" 
                                                value={formData.age} onChange={e => setFormData({...formData, age: e.target.value})} />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                                            <input required type="tel" className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-medical-500 outline-none" 
                                                value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Cobertura Médica</label>
                                            <select required className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-medical-500 outline-none bg-white"
                                                value={formData.insurance} onChange={e => setFormData({...formData, insurance: e.target.value})}>
                                                <option value="">Seleccionar...</option>
                                                {activeRoom.insurances.map(ins => <option key={ins} value={ins}>{ins}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    <div className="pt-4 mt-4 border-t border-gray-100">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Fecha del Turno</label>
                                        <input type="date" required 
                                            min={new Date().toISOString().split('T')[0]}
                                            className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-medical-500 outline-none"
                                            value={selectedDate} onChange={e => { setSelectedDate(e.target.value); setSelectedSlot(null); }} />
                                    </div>

                                    <div className="mt-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Horarios Disponibles</label>
                                        {availableSlots.length === 0 ? (
                                            <div className="p-4 bg-orange-50 text-orange-700 rounded-lg text-center text-sm border border-orange-100 flex flex-col items-center gap-1">
                                                <span className="font-semibold">Sin turnos disponibles</span>
                                                <span className="text-xs">
                                                    El consultorio atiende: {activeRoom.days.map(d => DAYS_LABEL[d]).join(', ')}.
                                                </span>
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-3 gap-2 max-h-48 overflow-y-auto pr-2">
                                                {availableSlots.map((slot, idx) => (
                                                    <button 
                                                        key={idx}
                                                        type="button"
                                                        onClick={() => setSelectedSlot(slot)}
                                                        className={`text-sm py-2 px-1 rounded-md border transition-colors ${
                                                            selectedSlot?.label === slot.label 
                                                            ? 'bg-medical-600 text-white border-medical-600 shadow-inner' 
                                                            : slot.priority === 1 
                                                                ? 'bg-medical-50 text-medical-800 border-medical-200 hover:bg-medical-100' // Agrupado (sugerido)
                                                                : 'bg-white text-gray-700 border-gray-200 hover:border-medical-300'
                                                        }`}
                                                    >
                                                        {slot.label}
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                        {availableSlots.some(s => s.priority === 1) && (
                                            <p className="text-xs text-medical-600 mt-2 flex items-center gap-1">
                                                <Clock size={12}/> Los horarios resaltados optimizan la agenda.
                                            </p>
                                        )}
                                    </div>
                                </form>
                            </Card>
                        </div>

                        {/* Columna Derecha: Resumen */}
                        <div>
                            <Card className="bg-medical-50 border-medical-200 h-full sticky top-24">
                                <h3 className="font-bold text-medical-900 mb-4">Resumen del Turno</h3>
                                <div className="space-y-3 text-sm">
                                    <div className="flex justify-between border-b border-medical-200 pb-2">
                                        <span className="text-medical-700">Consultorio:</span>
                                        <span className="font-medium text-right w-1/2">{activeRoom.name}</span>
                                    </div>
                                    <div className="flex justify-between border-b border-medical-200 pb-2">
                                        <span className="text-medical-700">Fecha:</span>
                                        <span className="font-medium">{formatDateDisplay(selectedDate)}</span>
                                    </div>
                                    <div className="flex justify-between border-b border-medical-200 pb-2">
                                        <span className="text-medical-700">Horario:</span>
                                        <span className={`font-bold ${selectedSlot ? 'text-medical-800' : 'text-gray-400'}`}>
                                            {selectedSlot ? selectedSlot.label : '--:--'}
                                        </span>
                                    </div>
                                    <div className="flex justify-between pt-2">
                                        <span className="text-medical-700">Paciente:</span>
                                        <span className="font-medium truncate">{formData.name || '-'}</span>
                                    </div>
                                </div>

                                <div className="mt-8">
                                    <Button fullWidth onClick={handleSubmit} disabled={!selectedSlot || !formData.name || isSubmitting}>
                                        {isSubmitting ? 'Confirmando...' : 'Confirmar Turno'}
                                    </Button>
                                    <p className="text-xs text-center text-gray-500 mt-3">
                                        Al confirmar, los datos se guardarán localmente primero.
                                    </p>
                                </div>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        // --- VISTA PROFESIONAL ---

        const ProfessionalView = ({ consultorios, appointments }) => {
            const [filterDate, setFilterDate] = useState(new Date().toISOString().split('T')[0]);
            const [filterRoom, setFilterRoom] = useState('all');

            const filteredAppointments = useMemo(() => {
                return appointments
                    .filter(apt => {
                        const matchDate = apt.date === filterDate;
                        const matchRoom = filterRoom === 'all' || apt.consultoryId === parseInt(filterRoom);
                        return matchDate && matchRoom;
                    })
                    .sort((a, b) => a.slot.localeCompare(b.slot));
            }, [appointments, filterDate, filterRoom]);

            return (
                <div className="fade-in space-y-6">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <h2 className="text-2xl font-bold text-gray-800">Agenda Médica</h2>
                        
                        <div className="flex gap-3 bg-white p-2 rounded-lg shadow-sm border border-gray-200">
                            <input 
                                type="date" 
                                className="border-gray-300 rounded-md text-sm focus:ring-medical-500 border p-2 outline-none"
                                value={filterDate}
                                onChange={(e) => setFilterDate(e.target.value)}
                            />
                            <select 
                                className="border-gray-300 rounded-md text-sm focus:ring-medical-500 border p-2 outline-none bg-white"
                                value={filterRoom}
                                onChange={(e) => setFilterRoom(e.target.value)}
                            >
                                <option value="all">Todos los Consultorios</option>
                                {consultorios.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </select>
                        </div>
                    </div>

                    <div className="grid md:grid-cols-4 gap-6">
                        {/* Estadísticas Rápidas */}
                        <Card className="md:col-span-4 bg-gradient-to-r from-medical-600 to-teal-500 text-white border-none">
                            <div className="flex justify-around text-center">
                                <div>
                                    <p className="text-medical-100 text-sm font-medium">Total Turnos Hoy</p>
                                    <p className="text-3xl font-bold">{filteredAppointments.length}</p>
                                </div>
                                <div className="border-l border-medical-400 pl-8">
                                    <p className="text-medical-100 text-sm font-medium">Consultorios Activos</p>
                                    <p className="text-3xl font-bold">
                                        {filterRoom === 'all' 
                                            ? new Set(filteredAppointments.map(a => a.consultoryId)).size 
                                            : (filteredAppointments.length > 0 ? 1 : 0)}
                                    </p>
                                </div>
                                <div className="border-l border-medical-400 pl-8 hidden sm:block">
                                    <p className="text-medical-100 text-sm font-medium">Obras Sociales</p>
                                    <p className="text-3xl font-bold">
                                        {new Set(filteredAppointments.map(a => a.insurance)).size}
                                    </p>
                                </div>
                            </div>
                        </Card>

                        {/* Listado */}
                        <div className="md:col-span-4">
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                    <h3 className="font-bold text-gray-700">Listado de Pacientes</h3>
                                    <span className="text-xs font-medium text-gray-500">{formatDateDisplay(filterDate)}</span>
                                </div>
                                
                                {filteredAppointments.length === 0 ? (
                                    <div className="p-12 text-center text-gray-400">
                                        <Calendar size={48} className="mx-auto mb-3 opacity-20" />
                                        <p>No hay turnos registrados para este criterio.</p>
                                    </div>
                                ) : (
                                    <div className="divide-y divide-gray-100">
                                        {filteredAppointments.map(apt => (
                                            <div key={apt.id} className="p-4 hover:bg-gray-50 transition-colors flex flex-col md:flex-row md:items-center justify-between gap-4">
                                                <div className="flex items-start gap-4">
                                                    <div className="bg-medical-100 text-medical-700 px-3 py-2 rounded-lg font-bold text-center min-w-[80px]">
                                                        {apt.slot}
                                                    </div>
                                                    <div>
                                                        <h4 className="font-bold text-gray-900">{apt.name} <span className="text-xs font-normal text-gray-500">({apt.age} años)</span></h4>
                                                        <div className="flex flex-wrap gap-x-4 gap-y-1 mt-1 text-sm text-gray-500">
                                                            <span className="flex items-center gap-1"><MapPin size={14}/> {apt.consultoryName}</span>
                                                            <span className="flex items-center gap-1"><Stethoscope size={14}/> {apt.insurance}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-3 md:justify-end">
                                                    <a href={`tel:${apt.phone}`} className="p-2 text-gray-400 hover:text-medical-600 hover:bg-medical-50 rounded-full transition-colors" title="Llamar">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                                                    </a>
                                                    <span className="text-xs font-medium px-2 py-1 bg-green-100 text-green-700 rounded-full">Confirmado</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
